name: CI (Linux)
on:
  workflow_call:
jobs:
  build:
    name: Linux
    runs-on: ubuntu-22.04
    steps:
    - name: Checkout source
      uses: actions/checkout@v3
    - name: Install System Packages
      run: |
        wget -qO - https://packages.lunarg.com/lunarg-signing-key-pub.asc | sudo tee /etc/apt/trusted.gpg.d/lunarg.asc
        sudo wget -qO /etc/apt/sources.list.d/lunarg-vulkan-1.3.239-jammy.list https://packages.lunarg.com/vulkan/1.3.239/lunarg-vulkan-1.3.239-jammy.list
        sudo apt update
        sudo apt install libxkbcommon-dev vulkan-sdk

        echo "VULKAN_SDK=/usr" >> $GITHUB_ENV
    - name: Build Flatpak
      run: flatpak-builder --default-branch dev build flatpak.yml
    - name: Export Flatpak
      run: flatpak build-export flatpak build
    - name: Bundle Flatpak
      run: flatpak build-bundle flatpak obliteration.flatpak io.github.obhq.Obliteration --runtime-repo=https://flathub.org/repo/flathub.flatpakrepo
    - name: Upload Flatpak
      uses: actions/upload-artifact@v3
      with:
        name: obliteration-linux
        path: obliteration.flatpak

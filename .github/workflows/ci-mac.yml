name: CI (Mac)
on:
  workflow_call:
jobs:
  build:
    name: Mac
    runs-on: macos-12
    steps:
    - name: Checkout source
      uses: actions/checkout@v3
    - name: Install Homebrew packages
      run: brew install qt@6
    - name: Cache CMake Build Files
      uses: actions/cache@v3.2.5
      id: cache-cmake
      with:
        path: |
          /home/runner/work/obliteration/obliteration/build
          /home/runner/work/obliteration/obliteration/src/target
        key: ${{ runner.os }}-cmake-${{ hashFiles('**/CMakeLists.*', '**/Cargo.lock', '**/Cargo.toml', '.github/workflows/*.yml') }}
    - name: Run CMake
      run: cmake --preset mac-release -DCMAKE_PREFIX_PATH=$(brew --prefix qt@6) .
    - name: Build
      run: cmake --build --preset mac-release
    - name: Prepare app bundle
      run: |
        mkdir -pv dist
        mv -v build/src/obliteration.app dist
    - name: Upload bundle
      uses: actions/upload-artifact@v3
      with:
        name: obliteration-mac-amd64
        path: dist
